name: FastFind.NET Build & Deploy
on:
  # Manual trigger - Always available for direct execution
  workflow_dispatch:
    inputs:
      push_to_nuget:
        description: 'Push packages to NuGet (even without version tag)'
        required: false
        default: false
        type: boolean
  # Automatic trigger - Only when version changes or workflow updates
  push:
    branches: [ "main" ]
    paths:
      - 'src/Directory.Build.props'    # Version changes trigger deployment
      - '.github/workflows/**'        # Workflow updates
  # Pull request validation - Build validation only (tests run locally)
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - '.github/workflows/**'

env:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: 'src/FastFind.sln'
  
jobs:
  # üîç PR ÎπåÎìú Í≤ÄÏ¶ù
  validate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src/Directory.Packages.props', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

  # üêß Linux ÌÖåÏä§Ìä∏ (PR + push to main)
  test-linux:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src/Directory.Packages.props', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Build Unix Tests
      run: dotnet build src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release

    - name: Run Linux Tests
      run: dotnet test src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release --no-build --logger "trx;LogFileName=test-results.trx" --results-directory ./test-results

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linux-test-results
        path: ./test-results/

  # üçé macOS ÌÖåÏä§Ìä∏ (ÏàòÎèô Ìä∏Î¶¨Í±∞ Ï†ÑÏö© ‚Äî ÎπÑÏö© ÏµúÏÜåÌôî)
  test-macos:
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src/Directory.Packages.props', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Build Unix Tests
      run: dotnet build src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release

    - name: Run macOS Tests
      run: dotnet test src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release --no-build --filter "Category!=Performance" --logger "trx;LogFileName=test-results.trx" --results-directory ./test-results

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: macos-test-results
        path: ./test-results/

  # üê≥ Linux Ìò∏ÌôòÏÑ± ÌÖåÏä§Ìä∏ (ÏàòÎèô Ìä∏Î¶¨Í±∞ Ï†ÑÏö©)
  test-linux-compat:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        container: ['mcr.microsoft.com/dotnet/sdk:10.0']
    container:
      image: ${{ matrix.container }}
    steps:
    - uses: actions/checkout@v4

    - name: Build & Test
      run: |
        dotnet build src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release
        dotnet test src/FastFind.Unix.Tests/FastFind.Unix.Tests.csproj --configuration Release --no-build

  # üì¶ ÎπåÎìú Î∞è Î∞∞Ìè¨ (ÌÖåÏä§Ìä∏Îäî Î°úÏª¨ÏóêÏÑúÎßå ÏàòÌñâ)
  pack-and-publish:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        project: 
          - path: 'src/FastFind/FastFind.csproj'
            name: 'FastFind.Core'
          - path: 'src/FastFind.Windows/FastFind.Windows.csproj'
            name: 'FastFind.Windows'
          - path: 'src/FastFind.SQLite/FastFind.SQLite.csproj'
            name: 'FastFind.SQLite'
          - path: 'src/FastFind.Unix/FastFind.Unix.csproj'
            name: 'FastFind.Unix'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version comparison

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src/Directory.Packages.props', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: Build ${{ matrix.project.name }}
      run: dotnet build ${{ matrix.project.path }} --configuration Release --no-restore
    
    - name: Pack ${{ matrix.project.name }}
      run: dotnet pack ${{ matrix.project.path }} --configuration Release --no-build --output nupkg
    
    - name: List generated packages
      run: ls -la nupkg/
    
    - name: Validate package
      run: |
        for package in nupkg/*.nupkg; do
          echo "Validating package: $package"
          dotnet nuget verify "$package" || echo "Package verification failed for $package"
        done
    
    - name: Extract Version from Directory.Build.props
      id: version
      run: |
        # Extract current version from Directory.Build.props
        CURRENT_VERSION=$(grep -oP '<Version>\K[^<]+' src/Directory.Build.props || echo "1.0.0")
        echo "CURRENT_VERSION=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
        echo "üì¶ Current version: ${CURRENT_VERSION}"

        # Create version tag format
        echo "VERSION_TAG=v${CURRENT_VERSION}" >> $GITHUB_OUTPUT

    - name: Check Version Change and Deploy Conditions
      id: deploy_check
      run: |
        CURRENT_VERSION="${{ steps.version.outputs.CURRENT_VERSION }}"
        VERSION_CHANGED="false"
        SHOULD_DEPLOY="false"
        REASON="no_trigger"

        echo "üîç Checking deployment conditions..."

        # Check if Directory.Build.props was changed in this push
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
          if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -q "src/Directory.Build.props"; then
            echo "‚úÖ Directory.Build.props was changed in this push"
            VERSION_CHANGED="true"

            # Get previous version for comparison
            PREVIOUS_VERSION=$(git show ${{ github.event.before }}:src/Directory.Build.props | grep -oP '<Version>\K[^<]+' || echo "0.0.0")
            echo "üìä Previous version: ${PREVIOUS_VERSION}"
            echo "üìä Current version: ${CURRENT_VERSION}"

            if [ "${PREVIOUS_VERSION}" != "${CURRENT_VERSION}" ]; then
              echo "üöÄ Version changed from ${PREVIOUS_VERSION} to ${CURRENT_VERSION}"
              if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                SHOULD_DEPLOY="true"
                REASON="version_change_on_main"
              else
                echo "‚ö†Ô∏è Version changed but not on main branch"
                REASON="version_change_not_main"
              fi
            else
              echo "‚ÑπÔ∏è Directory.Build.props changed but version remained the same"
              REASON="props_change_no_version"
            fi
          else
            echo "‚ÑπÔ∏è Directory.Build.props was not changed"
          fi
        fi

        # Manual trigger override
        if [ "${{ github.event.inputs.push_to_nuget }}" == "true" ]; then
          echo "üîß Manual deployment trigger activated"
          SHOULD_DEPLOY="true"
          REASON="manual_trigger"
        fi

        # Check if version already exists on NuGet (optional - can be enabled later)
        # We'll skip this for now to allow re-publishing same version if needed

        echo "SHOULD_DEPLOY=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
        echo "REASON=${REASON}" >> $GITHUB_OUTPUT
        echo "VERSION_CHANGED=${VERSION_CHANGED}" >> $GITHUB_OUTPUT
        echo "CURRENT_VERSION=${CURRENT_VERSION}" >> $GITHUB_OUTPUT

        echo "üìã Deployment Decision:"
        echo "   Should Deploy: ${SHOULD_DEPLOY}"
        echo "   Reason: ${REASON}"
        echo "   Version: ${CURRENT_VERSION}"
    
    - name: Push ${{ matrix.project.name }} to NuGet
      if: steps.deploy_check.outputs.SHOULD_DEPLOY == 'true'
      run: |
        echo "üöÄ Deploying ${{ matrix.project.name }} v${{ steps.deploy_check.outputs.CURRENT_VERSION }} to NuGet"
        echo "üìã Reason: ${{ steps.deploy_check.outputs.REASON }}"
        echo "üì¶ Packages in nupkg/:"
        ls -la nupkg/

        echo "üì§ Pushing to NuGet..."
        dotnet nuget push ./nupkg/*.nupkg \
          --source https://api.nuget.org/v3/index.json \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --skip-duplicate \
          --no-symbols

        echo "‚úÖ NuGet deployment completed for ${{ matrix.project.name }} v${{ steps.deploy_check.outputs.CURRENT_VERSION }}"
    
    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ matrix.project.name }}
        path: nupkg/*.nupkg
        retention-days: 30

  create-release:
    needs: [pack-and-publish]
    runs-on: ubuntu-latest
    if: needs.pack-and-publish.outputs.SHOULD_DEPLOY == 'true' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog generation

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Get version info
      id: version
      run: |
        if [ "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]; then
          VERSION="${{ github.ref_name }}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        else
          # Extract version from Directory.Build.props
          VERSION=$(grep -oP '<Version>\K[^<]+' src/Directory.Build.props || echo "1.0.0")
          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
        fi
        echo "Using version: ${VERSION}"
    
    - name: Generate changelog
      id: changelog
      run: |
        if [ "${{ steps.version.outputs.VERSION }}" != "$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo 'v0.0.0')" ]; then
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo 'HEAD~10')
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "### üìã Changes from ${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          git log ${PREVIOUS_TAG}..HEAD --oneline --pretty=format:'- %s (%h)' >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "CHANGELOG=### üìã Changes\nSee commit history for details." >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: FastFind.NET ${{ steps.version.outputs.VERSION }}
        body: |
          ## FastFind.NET ${{ steps.version.outputs.VERSION }}
          
          ### üì¶ Published Packages
          - **FastFind.Core**: Core interfaces, models, cross-platform SIMD string matching
          - **FastFind.Windows**: Windows-optimized implementation (MFT, USN Journal)
          - **FastFind.Unix**: Linux implementation (Channel BFS, inotify)
          - **FastFind.SQLite**: SQLite persistence with FTS5 full-text search

          ### üöÄ Key Features
          - Cross-platform SIMD string matching (Vector256/Vector128 auto-dispatch)
          - Memory-optimized string pooling (60-80% reduction)
          - Real-time file system monitoring (USN Journal / inotify)
          - Windows: NTFS MFT direct access (31K+ files/sec)
          - Linux: Channel-based BFS parallel enumeration
          - SQLite persistence with FTS5 full-text search
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### üì• Installation
          ```bash
          # Core package
          dotnet add package FastFind.Core

          # Windows implementation
          dotnet add package FastFind.Windows

          # SQLite persistence
          dotnet add package FastFind.SQLite
          ```
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        files: artifacts/**/*.nupkg
        generate_release_notes: true
        make_latest: ${{ !contains(steps.version.outputs.VERSION, '-') }}
